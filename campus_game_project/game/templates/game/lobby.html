<!DOCTYPE html>
<html>
  <head>
    <title>Lobby</title>

    <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
    integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
    crossorigin="anonymous">
    <link rel="stylesheet"
      href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/11.0.0/css/fabric.min.css"
    />
    {% load static %}
    <link rel="stylesheet" href="{% static 'game/app.css' %}">
    <link rel="stylesheet" href="{% static 'game/create.css'%}">
    <link rel="stylesheet" href="https://js.arcgis.com/4.22/esri/themes/light/main.css">

    <style>
        #map {
            position: absolute;
            height: 25%;
            width: 25%;
        }
    </style>

  </head>

  <body>
    <script src="https://js.arcgis.com/4.22/"></script>
    <div id="wrapper">
        <div id="content">
            <textarea id="log" cols="100" rows="20"></textarea><br>
            <input id="ready" type="button" value="Ready"><br><br>
            Players:
            <ul id="players">
            </ul>
        </div>
        <div id="settings">
            <h1>Current Settings</h1><br>
            <label id="hiding-time-label">Hiding Time:</label><br>
            <label id="seeking-time-label">Seeking Time:</label><br>
            <label id="seeker-num-label">Number of Seekers:</label><br>
            <div id="map"></div>
        </div>
    </div>
    {{ lobby_code|json_script:"lobby-code" }}
    {{ username|json_script:"username" }}
    {{ hiding_time|json_script:"hiding-time" }}
    {{ seeking_time|json_script:"seeking-time" }}
    {{ seeker_num|json_script:"seeker-num" }}
    {{ lobby_longitude|json_script:"lobby-longitude"}}
    {{ lobby_latitude|json_script:"lobby-latitude"}}
    <script>
        const code = JSON.parse(document.getElementById('lobby-code').textContent);
        const username = JSON.parse(document.getElementById('username').textContent);
        const hiding_time = JSON.parse(document.getElementById('hiding-time').textContent);
        const seeking_time = JSON.parse(document.getElementById('seeking-time').textContent);
        const seeker_num = JSON.parse(document.getElementById('seeker-num').textContent);
        const lobby_longitude = JSON.parse(document.getElementById('lobby-longitude').textContent);
        const lobby_latitude = JSON.parse(document.getElementById('lobby-latitude').textContent);

        document.getElementById('hiding-time-label').innerText += ' ' + hiding_time;
        document.getElementById('seeking-time-label').innerText += ' ' + seeking_time;
        document.getElementById('seeker-num-label').innerText += ' ' + seeker_num;


        document.title = code;

        // Establishes the websocket connection
        const lobbySocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/game/'
            + code
            + '/'
        );

        // When the websocket receives a message
        lobbySocket.onmessage = function(e) {
            const data = JSON.parse(e.data);

            switch(data.msg_type) {
                case "join":
                    var list = document.getElementById('players');
                    var player;

                    // If the user is joining, display all users currently in the lobby
                    if (document.getElementById('players').childElementCount == 0) {
                        for (var i = 0; i < data.players.length; i++) {
                            player = document.createElement('li');
                            player.id = data.players[i].username;
                            player.innerText = data.players[i].username;
                            if (data.players[i].ready) {
                                player.style.color = 'green';
                            } else {
                                player.style.color = 'red';
                            }
                            list.appendChild(player);
                        }
                    // If a new user joins, display them
                    } else {
                        player = document.createElement('li');
                        player.id = data.username;
                        player.innerText = data.username;
                        player.style.color = "red";
                        list.appendChild(player);
                    }
                    break;

                case "leave":
                    // If a user leaves, remove them from the display
                    var item = document.getElementById(data.username);
                    item.remove()
                    break;

                case "ready":
                    // Changes colour of user in the display if they are ready or not ready
                    console.log("Username: " + data.username);
                    console.log("Ready User: " + data.ready_user);
                    if (data.ready) {
                        if (data.username == data.ready_user) {
                            document.getElementById('ready').value = 'Unready';
                        }
                        document.getElementById(data.ready_user).style.color = "green";
                    } else {
                        if (data.username == data.ready_user) {
                            document.getElementById('ready').value = 'Ready';
                        }
                        document.getElementById(data.ready_user).style.color = "red";
                    }
                    break;

                case "start":
                    lobbySocket.send(JSON.stringify({
                        'msg_type': "playing",
                    }))
                    window.location= "../../game/running/" + code;
                    break;
            }
            
            // Displays the message on screen if one exists
            if (data.message) {
                document.querySelector('#log').value += (data.message + '\n')
            }
        }

        // Send a message to the socket when the player is ready
        document.querySelector('#ready').onclick = function(e) {
            navigator.geolocation.getCurrentPosition((position) => {
                ready = document.getElementById('ready').value
                lobbySocket.send(JSON.stringify({
                    'msg_type': "ready",
                    'ready':ready,
                    'username':username,
                }));
            },
            () => {alert("Please enable location tracking.");});
        };
    </script>
    <script>
        const long = JSON.parse(document.getElementById('lobby-longitude').textContent);
        const lat = JSON.parse(document.getElementById('lobby-latitude').textContent);

        require([
          "esri/config",
          "esri/Map",
          "esri/views/MapView",
          "esri/widgets/Locate",

          "esri/widgets/Track",
          "esri/Graphic"

        ], function(
            esriConfig,
            Map,
            MapView,
            Locate,

            Track,
            Graphic

        ) {

            esriConfig.apiKey = "AAPKaa849a30bba54d82bd5ed0003c6adc27kS5-ZFgUiX98pw--6E5-HMGUyhqgQqfB1ha6nY5FZD8Rp-DtLWmWQGjmn7eNCigt";

            const map = new Map({
                basemap: "arcgis-navigation"
            });

            window.view = new MapView({
                container: "map",
                map: map,
                center: [long, lat],
                zoom: 10
            })

            track(long, lat);

        });

        function track(long, lat) {
            window.view.goTo({
            center: [long, lat],
            scale: 1500
            })
        }
        
    </script>
</body>
</html>
