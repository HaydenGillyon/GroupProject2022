<!DOCTYPE html>
<html>
    <head>
        <title>Running</title>

        <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3"
        crossorigin="anonymous">
        <link rel="stylesheet"
        href="https://static2.sharepointonline.com/files/fabric/office-ui-fabric-core/11.0.0/css/fabric.min.css"
        />
        {% load static %}
        <link rel="stylesheet" href="{% static 'game/app.css' %}">
        <link rel="stylesheet" href="{% static 'game/create.css'%}">
    </head>
    <body>
        <h1 id="content"></h1>
        <h1 id="time" style="color: crimson;"></h1>
        <h2 id="player-msg"></h2>
        <h2 id="hcode"></h2>
        {% if not hider_code %}
            <h2>Enter a Hider Code:</h2>
            <input style="border: 1px solid black; font-size: larger;" type="text" id="code-attempt-box">
            <button style="font-size: larger;" id="do-attempt">Try Code</button>
            <h2 id="code-result"></h2>
        {% endif %}
        <h2 id="warningbox-outbounds"></h2>

        {{ lobby_code|json_script:"lobby-code" }}
        {{ username|json_script:"username" }}
        {{ seeker|json_script:"seeker" }}
        {{ hider_code|json_script:"hider-code"}}
        {{ start_time|json_script:"start-time"}}
        {{ hiding_time|json_script:"hiding-time" }}
        {{ seeking_time|json_script:"seeking-time" }}
        <script>
            const code = JSON.parse(document.getElementById('lobby-code').textContent);
            const username = JSON.parse(document.getElementById('username').textContent);
            const seeker = JSON.parse(document.getElementById('seeker').textContent);
            const hider_code = JSON.parse(document.getElementById('hider-code').textContent);
            const start_time = JSON.parse(document.getElementById('start-time').textContent);
            
            document.getElementById('content').innerText = 'Hide and Seek - Game ' + code;
            
            const player_type = seeker ? 'seeking!' : 'hiding!';
            const player_msg = document.getElementById('player-msg')
            player_msg.innerText = username + ', you are ' + player_type;
            const warningbox_outbounds = document.getElementById('warningbox-outbounds');

            if (hider_code) {
                hider_code_element = document.getElementById('hcode')
                hider_code_element.innerText = 'Secret Hider Code: ' + hider_code;
                hider_code_element.style.border = '1px solid black';
            }

            document.title = code;

            // Establishes the websocket connection
            const lobbySocket = new WebSocket(
                'ws://'
                + window.location.host
                + '/ws/game/running/'
                + code
                + '/'
            );
            </script>
            {% if not hider_code %}
            <script>
            document.getElementById('do-attempt').onclick = function(e) {
                let attempt_code = document.getElementById('code-attempt-box').value
                lobbySocket.send(JSON.stringify({
                    'msg_type' : 'hider_code_attempt',
                    'attempt_code' : attempt_code,
                    'username': username,
                }));
            };
            </script>
            {% endif %}
            <script>
            // Game Timer
            const time_left_text = document.getElementById('time');
            const hiding_duration = parseInt(JSON.parse(document.getElementById('hiding-time').textContent));
            const seeking_duration = parseInt(JSON.parse(document.getElementById('seeking-time').textContent));
            const total_duration = hiding_duration + seeking_duration;
            (function checkTime() {
                let time = Date.now() / 1000
                let elapsed = time - start_time;
                time_left_text.innerText = Math.floor((total_duration - elapsed)) + " seconds remaining";

                if (elapsed > total_duration) {
                    // End game, seeker loses, inform other clients
                    lobbySocket.send(JSON.stringify({
                    'msg_type' : 'seeking_over',
                    }));
                } else if (elapsed > hiding_duration) {
                    player_msg.innerText = username + ', you are ' + player_type
                        + ' Searching has begun!';
                }
                setTimeout(checkTime, 500);
            })();

            lobbySocket.onmessage = function(e) {
                const data = JSON.parse(e.data);

                switch(data.msg_type) {
                    case 'code_result':
                        document.getElementById('code-result').innerText = data.result;
                        break;
                    case 'end':
                        window.location= "../../end/" + code;
                        break;
                    case 'outbounds_alert':
                        // Alert player they are out of bounds and will be kicked soon
                        outboundsWarning(true);
                        current_position.outbounds_timestamp = current_position.timestamp;
                        break;
                    case 'inbounds_alert':
                        // If player returns into the radius of the map
                        outboundsWarning(false);
                        current_position.outbounds_timestamp = 0;
                        break;
                    case 'outbounds_kick':
                        // If out of bounds for too long
                        window.location="../../error/";
                        break;
                }
            }

            // Tracker Code
            const current_position = {
                latitude: 0,
                longitude: 0,
                timestamp: 0,
                outbounds_timestamp: 0
            };

            // Wait for socket to open before sending position updates
            lobbySocket.onopen = () => {
                navigator.geolocation.watchPosition(showPosition, positionError, {enableHighAccuracy : true});
            }

            function showPosition(position) {
                // Do not update position more than once every four seconds
                if (position.timestamp - current_position.timestamp > 4000) {
                    current_position.latitude = position.coords.latitude;
                    current_position.longitude = position.coords.longitude;
                    current_position.timestamp = position.timestamp;

                    if (current_position.outbounds_timestamp) {
                        // Checks if player is still out of bounds
                        lobbySocket.send(JSON.stringify({
                            'msg_type' : 'outbounds_update',
                            'player_latitude' : current_position.latitude,
                            'player_longitude' : current_position.longitude,
                            'timestamp' : current_position.timestamp,
                            'outbounds_timestamp' : current_position.outbounds_timestamp
                        }));
                    } else {
                        // Normal position update
                        lobbySocket.send(JSON.stringify({
                            'msg_type' : 'position_update',
                            'player_latitude' : current_position.latitude,
                            'player_longitude' : current_position.longitude
                        }));
                    }
                }
            }
            function outboundsWarning(display_warning) {
                if (display_warning) {
                    warningbox_outbounds.style.backgroundColor = "Yellow";
                    warningbox_outbounds.innerText
                            = "You are out of bounds! Return soon or the radiation will get you!";
                } else {
                    warningbox_outbounds.style.backgroundColor = null;
                    warningbox_outbounds.innerText
                            = null;
                }
            }
            function positionError(err) {
                // If location permission revoked
                window.location= "../../error/";
            }
        </script>
    </body>
</html>